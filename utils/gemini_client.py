import os
import logging
from google import genai
from google.genai import types

class GeminiClient:
    def __init__(self):
        """Initialize Gemini client with API key from environment variables."""
        api_key = os.getenv("GEMINI_API_KEY")
        if not api_key:
            raise ValueError("GEMINI_API_KEY environment variable is required")
        
        self.client = genai.Client(api_key=api_key)
        self.model = "gemini-1.5-pro"
    
    def get_tourism_response(self, user_query: str, language: str = "English") -> str:
        """
        Get tourism-related response from Gemini API.
        
        Args:
            user_query (str): User's question or request
            language (str): Target language for response
            
        Returns:
            str: AI-generated response about tourism
        """
        try:
            # Simple, focused prompt
            prompt = f"You are a tourism guide for Andhra Pradesh, India. User asks: {user_query}. Provide helpful tourism information about Andhra Pradesh including temples, beaches, food, and attractions. Respond in {language}."
            
            response = self.client.models.generate_content(
                model=self.model,
                contents=prompt
            )
            
            if response and response.text:
                return response.text.strip()
            else:
                return self._get_fallback_response(user_query, language)
                
        except Exception as e:
            logging.error(f"Error in get_tourism_response: {str(e)}")
            return self._get_fallback_response(user_query, language)
    
    def _get_fallback_response(self, user_query: str, language: str) -> str:
        """Provide fallback responses when API fails"""
        query_lower = user_query.lower()
        
        # Temple responses
        if any(word in query_lower for word in ['temple', 'mandir', 'рджреЗрд╡рд╛рд▓рдп', 'р░жр▒Зр░╡р░╛р░▓р░пр░В']):
            responses = {
                "English": """ЁЯПЫя╕П **Famous Temples of Andhra Pradesh**

**Tirupati Balaji Temple** - The world's most visited religious site with millions of devotees annually. Located in Tirupati, it's dedicated to Lord Venkateswara.

**Kanaka Durga Temple** - Situated on Indrakeeladri Hill in Vijayawada, this temple offers stunning views of the Krishna River.

**Srisailam Temple** - One of the 12 Jyotirlingas, located in the Nallamala forest along the Krishna River.

*Tip: Book accommodation and darshan tickets in advance, especially for Tirupati.*""",
                "Hindi": """ЁЯПЫя╕П **рдЖрдВрдзреНрд░ рдкреНрд░рджреЗрд╢ рдХреЗ рдкреНрд░рд╕рд┐рджреНрдз рдордВрджрд┐рд░**

**рддрд┐рд░реБрдкрддрд┐ рдмрд╛рд▓рд╛рдЬреА рдордВрджрд┐рд░** - рджреБрдирд┐рдпрд╛ рдХрд╛ рд╕рдмрд╕реЗ рдЬреНрдпрд╛рджрд╛ рджреЗрдЦрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдзрд╛рд░реНрдорд┐рдХ рд╕реНрдерд▓ред

**рдХрдирдХ рджреБрд░реНрдЧрд╛ рдордВрджрд┐рд░** - рд╡рд┐рдЬрдпрд╡рд╛рдбрд╝рд╛ рдореЗрдВ рдХреГрд╖реНрдгрд╛ рдирджреА рдХреЗ рдХрд┐рдирд╛рд░реЗ рд╕реНрдерд┐рддред

**рд╢реНрд░реАрд╢реИрд▓рдо рдордВрджрд┐рд░** - 12 рдЬреНрдпреЛрддрд┐рд░реНрд▓рд┐рдВрдЧреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ, рдХреГрд╖реНрдгрд╛ рдирджреА рдХреЗ рддрдЯ рдкрд░ред""",
                "Telugu": """ЁЯПЫя╕П **р░Жр░Вр░зр▒Нр░░ р░кр▒Нр░░р░жр▒Зр░╢р▒Н р░кр▒Нр░░р░╕р░┐р░жр▒Нр░з р░жр▒Зр░╡р░╛р░▓р░пр░╛р░▓р▒Б**

**р░др░┐р░░р▒Бр░кр░др░┐ р░мр░╛р░▓р░╛р░Ьр▒А р░жр▒Зр░╡р░╛р░▓р░пр░В** - р░кр▒Нр░░р░кр░Вр░Ър░Вр░▓р▒Л р░Ер░др▒Нр░пр░зр░┐р░Хр░Вр░Чр░╛ р░╕р░Вр░жр░░р▒Нр░╢р░Хр▒Бр░▓р▒Б р░╡р░Ър▒Нр░Ър▒З р░Жр░зр▒Нр░пр░╛р░др▒Нр░ор░┐р░Х р░Хр▒Зр░Вр░жр▒Нр░░р░Вред

**р░Хр░ир░Х р░жр▒Бр░░р▒Нр░Чр░╛ р░жр▒Зр░╡р░╛р░▓р░пр░В** - р░╡р░┐р░Ьр░пр░╡р░╛р░бр░▓р▒Л р░Хр▒Гр░╖р▒Нр░гр░╛ р░ир░жр░┐ р░Тр░бр▒Нр░бр▒Бр░и р░Йр░ир▒Нр░и р░кр░╡р░┐р░др▒Нр░░ р░Хр▒Нр░╖р▒Зр░др▒Нр░░р░Вред

**р░╢р▒Нр░░р▒Ар░╢р▒Ир░▓р░В р░жр▒Зр░╡р░╛р░▓р░пр░В** - 12 р░Ьр▒Нр░пр▒Лр░др░┐р░░р▒Нр░▓р░┐р░Вр░Чр░╛р░▓р░▓р▒Л р░Тр░Хр░Яр░┐, р░Хр▒Гр░╖р▒Нр░гр░╛ р░ир░жр░┐ р░др▒Ар░░р░Вр░▓р▒Л."""
            }
            
        # Beach responses
        elif any(word in query_lower for word in ['beach', 'coast', 'sea', 'рд╕рдореБрджреНрд░', 'р░др▒Ар░░р░В']):
            responses = {
                "English": """ЁЯПЦя╕П **Beautiful Beaches of Andhra Pradesh**

**Visakhapatnam Beaches** - RK Beach is perfect for evening walks with beautiful sunsets and beach activities.

**Rushikonda Beach** - Known for its golden sand and water sports like surfing and jet skiing.

**Yarada Beach** - A hidden gem with pristine beauty, surrounded by hills and less crowded.

*Activities: Water sports, beach volleyball, local seafood, dolphin watching*""",
                "Hindi": """ЁЯПЦя╕П **рдЖрдВрдзреНрд░ рдкреНрд░рджреЗрд╢ рдХреЗ рд╕реБрдВрджрд░ рд╕рдореБрджреНрд░реА рддрдЯ**

**рд╡рд┐рд╢рд╛рдЦрд╛рдкрддреНрддрдирдо рдмреАрдЪ** - рдЖрд░рдХреЗ рдмреАрдЪ рд╢рд╛рдо рдХреА рд╕реИрд░ рдФрд░ рд╕реВрд░реНрдпрд╛рд╕реНрдд рдХреЗ рд▓рд┐рдП рдмреЗрд╣рддрд░реАрдиред

**рд░реБрд╢рд┐рдХреЛрдВрдбрд╛ рдмреАрдЪ** - рд╕реНрд╡рд░реНрдгрд┐рдо рд░реЗрдд рдФрд░ рдЬрд▓ рдХреНрд░реАрдбрд╝рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╕рд┐рджреНрдзред

**рдпрд╛рд░рджрд╛ рдмреАрдЪ** - рдкрд╣рд╛рдбрд╝рд┐рдпреЛрдВ рд╕реЗ рдШрд┐рд░рд╛ рд╣реБрдЖ рд╢рд╛рдВрдд рдФрд░ рд╕реБрдВрджрд░ рд╕рдореБрджреНрд░реА рддрдЯред""",
                "Telugu": """ЁЯПЦя╕П **р░Жр░Вр░зр▒Нр░░ р░кр▒Нр░░р░жр▒Зр░╢р▒Н р░Ер░Вр░жр░ор▒Ир░и р░др▒Ар░░р░╛р░▓р▒Б**

**р░╡р░┐р░╢р░╛р░Цр░кр░Яр▒Нр░ир░В р░др▒Ар░░р░╛р░▓р▒Б** - р░Жр░░р▒Нр░Хр▒З р░мр▒Ар░Ър▒Н р░╕р░╛р░пр░Вр░др▒Нр░░р░В р░ир░бр░Х р░ор░░р░┐р░пр▒Б р░╕р▒Вр░░р▒Нр░пр░╛р░╕р▒Нр░др░ор░пр░╛р░ир░┐р░Хр░┐ р░Ер░жр▒Нр░нр▒Бр░др░В.

**р░░р▒Бр░╖р░┐р░Хр▒Кр░Вр░б р░др▒Ар░░р░В** - р░мр░Вр░Чр░╛р░░р▒Б р░Зр░╕р▒Бр░Х р░ор░░р░┐р░пр▒Б р░╡р░╛р░Яр░░р▒Н р░╕р▒Нр░кр▒Лр░░р▒Нр░Яр▒Нр░╕р▒Н р░Хр▒Б р░кр▒Нр░░р░╕р░┐р░жр▒Нр░зр░┐.

**р░пр░╛р░░р░ж р░др▒Ар░░р░В** - р░Хр▒Кр░Вр░бр░▓р░др▒Л р░Ър▒Бр░Яр▒Нр░Яр▒Бр░ор▒Бр░Яр▒Нр░Яр░мр░бр░┐р░и р░кр▒Нр░░р░╢р░╛р░Вр░д р░ор░░р░┐р░пр▒Б р░Ер░Вр░жр░ор▒Ир░и р░кр▒Нр░░р░жр▒Зр░╢р░В."""
            }
            
        # Itinerary/Plan responses
        elif any(word in query_lower for word in ['plan', 'itinerary', 'trip', 'рдпреЛрдЬрдирд╛', 'р░кр▒Нр░░р░гр░╛р░│р░┐р░Х']):
            responses = {
                "English": """ЁЯУЛ **3-Day Andhra Pradesh Itinerary**

**Day 1: Tirupati**
- Morning: Tirumala Balaji Temple darshan
- Afternoon: TTD Gardens and local markets
- Evening: Rest and local cuisine

**Day 2: Visakhapatnam**
- Morning: Travel to Vizag (4 hours)
- Afternoon: RK Beach and Submarine Museum
- Evening: Kailasagiri Hill Park

**Day 3: Araku Valley**
- Full day trip to Araku Valley (hill station)
- Coffee plantations and tribal museum
- Return to Vizag evening

*Budget: тВ╣8,000-12,000 per person including stay, food, and transport*""",
                "Hindi": """ЁЯУЛ **3-рджрд┐рди рдЖрдВрдзреНрд░ рдкреНрд░рджреЗрд╢ рдпрд╛рддреНрд░рд╛ рдпреЛрдЬрдирд╛**

**рджрд┐рди 1: рддрд┐рд░реБрдкрддрд┐**
- рд╕реБрдмрд╣: рддрд┐рд░реБрдорд▓рд╛ рдмрд╛рд▓рд╛рдЬреА рдордВрджрд┐рд░ рджрд░реНрд╢рди
- рджреЛрдкрд╣рд░: рдЯреАрдЯреАрдбреА рдЧрд╛рд░реНрдбрди
- рд╢рд╛рдо: рдЖрд░рд╛рдо рдФрд░ рд╕реНрдерд╛рдиреАрдп рднреЛрдЬрди

**рджрд┐рди 2: рд╡рд┐рд╢рд╛рдЦрд╛рдкрддреНрддрдирдо**
- рд╕реБрдмрд╣: рд╡рд┐рдЬрд╛рдЧ рдХреА рдпрд╛рддреНрд░рд╛
- рджреЛрдкрд╣рд░: рдЖрд░рдХреЗ рдмреАрдЪ
- рд╢рд╛рдо: рдХреИрд▓рд╛рд╕рдЧрд┐рд░рд┐ рдкрд╛рд░реНрдХ

**рджрд┐рди 3: рдЕрд░рд╛рдХреВ рдШрд╛рдЯреА**
- рдкреВрд░рд╛ рджрд┐рди рдЕрд░рд╛рдХреВ рдШрд╛рдЯреА
- рдХреЙрдлреА рдмрд╛рдЧрд╛рди рдФрд░ рдЖрджрд┐рд╡рд╛рд╕реА рд╕рдВрдЧреНрд░рд╣рд╛рд▓рдп""",
                "Telugu": """ЁЯУЛ **3-р░░р▒Лр░Ьр▒Бр░▓ р░Жр░Вр░зр▒Нр░░ р░кр▒Нр░░р░жр▒Зр░╢р▒Н р░кр▒Нр░░р░пр░╛р░г р░кр▒Нр░░р░гр░╛р░│р░┐р░Х**

**р░░р▒Лр░Ьр▒Б 1: р░др░┐р░░р▒Бр░кр░др░┐**
- р░Йр░жр░пр░В: р░др░┐р░░р▒Бр░ор░▓ р░мр░╛р░▓р░╛р░Ьр▒А р░жр░░р▒Нр░╢р░ир░В
- р░ор░зр▒Нр░пр░╛р░╣р▒Нр░ир░В: TTD р░Чр░╛р░░р▒Нр░бр▒Жр░ир▒Нр░╕р▒Н
- р░╕р░╛р░пр░Вр░др▒Нр░░р░В: р░╡р░┐р░╢р▒Нр░░р░╛р░Вр░др░┐ р░ор░░р░┐р░пр▒Б р░╕р▒Нр░ер░╛р░ир░┐р░Х р░╡р░Вр░Яр░Хр░╛р░▓р▒Б

**р░░р▒Лр░Ьр▒Б 2: р░╡р░┐р░╢р░╛р░Цр░кр░Яр▒Нр░ир░В**
- р░Йр░жр░пр░В: р░╡р░┐р░Ьр░╛р░Чр▒Н р░кр▒Нр░░р░пр░╛р░гр░В
- р░ор░зр▒Нр░пр░╛р░╣р▒Нр░ир░В: р░Жр░░р▒Нр░Хр▒З р░мр▒Ар░Ър▒Н
- р░╕р░╛р░пр░Вр░др▒Нр░░р░В: р░Хр▒Ир░▓р░╛р░╕р░Чр░┐р░░р░┐ р░кр░╛р░░р▒Нр░Хр▒Н

**р░░р▒Лр░Ьр▒Б 3: р░Ер░░р░Хр▒Б р░▓р▒Лр░п**
- р░кр▒Вр░░р▒Нр░др░┐ р░░р▒Лр░Ьр▒Б р░Ер░░р░Хр▒Б р░▓р▒Лр░п р░╕р░Вр░жр░░р▒Нр░╢р░и
- р░Хр░╛р░лр▒А р░др▒Лр░Яр░▓р▒Б р░ор░░р░┐р░пр▒Б р░Чр░┐р░░р░┐р░Ьр░и р░ор▒Нр░пр▒Вр░Ьр░┐р░пр░В"""
            }
        else:
            responses = {
                "English": """ЁЯЩП **Welcome to Andhra Pradesh Tourism!**

Andhra Pradesh offers incredible diversity:

ЁЯПЫя╕П **Spiritual Sites**: Tirupati (most visited temple), Srisailam, Vijayawada
ЁЯПЦя╕П **Coastal Beauty**: Visakhapatnam beaches, coastal cuisine
ЁЯПФя╕П **Hill Stations**: Araku Valley, Horsley Hills
ЁЯНЫ **Cuisine**: Spicy Andhra biryani, seafood, traditional thali
ЁЯОн **Culture**: Kuchipudi dance, Kalamkari art, local festivals

Ask me about specific places, food, or say 'plan my trip' for detailed itineraries!""",
                "Hindi": """ЁЯЩП **рдЖрдВрдзреНрд░ рдкреНрд░рджреЗрд╢ рдкрд░реНрдпрдЯрди рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ!**

рдЖрдВрдзреНрд░ рдкреНрд░рджреЗрд╢ рдХреА рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╡рд┐рд╡рд┐рдзрддрд╛:

ЁЯПЫя╕П **рдЖрдзреНрдпрд╛рддреНрдорд┐рдХ рд╕реНрдерд▓**: рддрд┐рд░реБрдкрддрд┐, рд╢реНрд░реАрд╢реИрд▓рдо
ЁЯПЦя╕П **рддрдЯреАрдп рд╕реБрдВрджрд░рддрд╛**: рд╡рд┐рд╢рд╛рдЦрд╛рдкрддреНрддрдирдо рдХреЗ рд╕рдореБрджреНрд░реА рддрдЯ
ЁЯПФя╕П **рдкрд╣рд╛рдбрд╝реА рд╕реНрдЯреЗрд╢рди**: рдЕрд░рд╛рдХреВ рдШрд╛рдЯреА
ЁЯНЫ **рд╡реНрдпрдВрдЬрди**: рддреАрдЦреА рдЖрдВрдзреНрд░ рдмрд┐рд░рдпрд╛рдиреА

рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕реНрдерд╛рдиреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреВрдЫреЗрдВ!""",
                "Telugu": """ЁЯЩП **р░Жр░Вр░зр▒Нр░░ р░кр▒Нр░░р░жр▒Зр░╢р▒Н р░кр░░р▒Нр░пр░Яр░ир░Хр▒Б р░╕р▒Нр░╡р░╛р░Чр░др░В!**

р░Жр░Вр░зр▒Нр░░ р░кр▒Нр░░р░жр▒Зр░╢р▒Н р░пр▒Кр░Хр▒Нр░Х р░Ер░жр▒Нр░нр▒Бр░др░ор▒Ир░и р░╡р▒Ир░╡р░┐р░зр▒Нр░пр░В:

ЁЯПЫя╕П **р░Жр░зр▒Нр░пр░╛р░др▒Нр░ор░┐р░Х р░Хр▒Зр░Вр░жр▒Нр░░р░╛р░▓р▒Б**: р░др░┐р░░р▒Бр░кр░др░┐, р░╢р▒Нр░░р▒Ар░╢р▒Ир░▓р░В
ЁЯПЦя╕П **р░др▒Ар░░ р░Ер░Вр░жр░╛р░▓р▒Б**: р░╡р░┐р░╢р░╛р░Цр░кр░Яр▒Нр░ир░В р░др▒Ар░░р░╛р░▓р▒Б
ЁЯПФя╕П **р░Хр▒Кр░Вр░б р░кр▒Нр░░р░╛р░Вр░др░╛р░▓р▒Б**: р░Ер░░р░Хр▒Б р░▓р▒Лр░п
ЁЯНЫ **р░╡р░Вр░Яр░Хр░╛р░▓р▒Б**: р░Жр░Вр░зр▒Нр░░ р░мр░┐р░░р▒Нр░пр░╛р░ир▒А, р░╕р▒Ар░лр▒Бр░бр▒Н

р░ир░┐р░░р▒Нр░жр░┐р░╖р▒Нр░Я р░кр▒Нр░░р░жр▒Зр░╢р░╛р░▓ р░Чр▒Бр░░р░┐р░Вр░Ър░┐ р░Ер░бр░Чр░Вр░бр░┐!"""
            }
        
        return responses.get(language, responses["English"])
    
    def generate_structured_response(self, prompt: str, response_schema=None) -> str:
        """
        Generate structured response for specific formats like itineraries.
        
        Args:
            prompt (str): Detailed prompt for structured content
            response_schema: Optional Pydantic model for structured output
            
        Returns:
            str: Structured response from Gemini
        """
        try:
            config = types.GenerateContentConfig(
                system_instruction=self.system_prompt,
                temperature=0.5,
                max_output_tokens=1000
            )
            
            if response_schema:
                config.response_mime_type = "application/json"
                config.response_schema = response_schema
            
            response = self.client.models.generate_content(
                model=self.model,
                contents=prompt,
                config=config
            )
            
            if response.text:
                return response.text.strip()
            else:
                return "Unable to generate structured response."
                
        except Exception as e:
            logging.error(f"Error in generate_structured_response: {str(e)}")
            return f"Error generating response: {str(e)}"
